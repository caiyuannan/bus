<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.bus.dao.LccDriverManageMapper">

    <resultMap id="driverMap" type="com.bus.javabean.LccDriverBean">
        <result property="driverId" column="driver_id"/>
        <result property="driverName" column="driver_name"/>
    </resultMap>

<!--    <select id="queryDriver" resultMap="driverMap">-->
<!--            select * from tb_driver where driver_state = '启用'-->
<!--    </select>-->

<!--    <select id="checkDriverWork" resultType="java.lang.Integer">-->
<!--        select count(*) from tb_gate_card where work_date = #{driverId} and driver_id-->
<!--        =-->
<!--        (SELECT driver_id from tb_crew_scheduling where driver_id =#{date})-->
<!--    </select>-->



    <resultMap id="weekWorkMap" type="com.bus.javabean.LccCrewSchedulingBean">
        <result property="workId" column="work_id"/>
        <result property="driverId" column="driver_id"/>
        <result property="busWorkId" column="bus_work_id"/>
        <result property="driverName" column="driver_name"/>
        <result property="workTime" column="work_time"/>
        <result property="busIicense" column="bus_license"/>
        <result property="workType" column="work_type"/>
        <result property="startTime" column="work_time"/>
        <result property="endTime" column="work_time"/>
    </resultMap>

    <select id="queryWeekWork" parameterType="com.bus.javabean.LccCrewSchedulingBean" resultMap="weekWorkMap">
 SELECT * from(
 select*from
    (SELECT a.work_type,a.work_id,a.driver_id,a.work_time,b.driver_name from
    (SELECT work_type,driver_id,work_time,work_id from tb_crew_scheduling)a
    LEFT JOIN
    (SELECT driver_name,driver_id from tb_driver)b
    on a.driver_id = b.driver_id)c
    LEFT JOIN
    (select bus_id,bus_license from tb_bus)d
    on c.work_type = d.bus_license)e  WHERE 1=1
    <if test="workType!=null and workType!=''">and e.work_type=#{workType}</if>
    <if test="startTime!=null and startTime!=''">and e.work_time&gt;=#{startTime}</if>
    <if test="endTime!=null and endTime!=''">and e.work_time&lt;=#{endTime}</if>
    </select>

    <select id="findBusWorkIdByBusIicense" parameterType="java.lang.String" resultType="int">
        SELECT bus_id FROM tb_bus where bus_license = #{busIicense}
    </select>


    <update id="updateDriverWork" parameterType="com.bus.javabean.LccCrewSchedulingBean">
        UPDATE tb_crew_scheduling
        <trim prefix="set" suffixOverrides=",">
            <if test="workType!=null">work_type=#{workType},</if>
        </trim>
        WHERE work_id =#{workId}
    </update>

    <insert id="addDriverWork" parameterType="com.bus.javabean.LccCrewSchedulingBean">
        insert into tb_crew_scheduling (driver_id,work_time,work_type)
         values (#{driverId},#{workTime},#{workType});
    </insert>
    
    

    <resultMap id="busMap" type="com.bus.javabean.DyfBusBean">
        <id property="busId" column="bus_id"></id>
        <result property="busAge" column="bus_age"></result>
        <result property="busDutyDriver" column="bus_duty_driver"></result>
        <result property="busLicense" column="bus_license"></result>
        <result property="busMin" column="bus_min"></result>
        <result property="busType" column="bus_type"></result>
        <result property="busState" column="bus_state"></result>
        <result property="stateName" column="state_name"></result>
    </resultMap>
    <select id="findAllBuses" parameterType="com.bus.javabean.DyfBusBean" resultMap="busMap">
        SELECT * from tb_bus
    </select>

    <resultMap id="routeMap" type="com.bus.javabean.LccRouteBean">
        <result property="routeId" column="route_id"></result>
        <result property="routeName" column="route_name"></result>
        <result property="routeFee" column="route_fee"></result>
        <result property="routeTime" column="route_time"></result>
        <result property="stateId" column="state_id"></result>
        <result property="cityName" column="city_name"></result>
    </resultMap>
    <select id="findAllRoutes" parameterType="com.bus.javabean.LccRouteBean" resultMap="routeMap">
        SELECT * from tb_route
    </select>
    
    <select id="findAllDriver" parameterType="com.bus.javabean.LccDriverBean" resultMap="driverMap">
        SELECT * from tb_driver
    </select>
    
    
    <select id="findDriverId" resultType="Integer">
        select DISTINCT driver_id from tb_crew_scheduling
    </select>

    <insert id="insertBlankWork" parameterType="com.bus.javabean.LccCrewSchedulingBean">
        insert REPLACE INTO tb_crew_scheduling(driver_id,work_time,work_type)
        values (#{driverId},#{workTime},#{workType})
    </insert>


    <select id="queryDriverIdByDriverName" parameterType="string" resultType="int">
        select driver_id from tb_driver where driver_name=#{driverName}
    </select>


    <resultMap id="busShfitMap" type="com.bus.javabean.LccBusShfitBean">
        <result property="shfitId" column="shfit_id"/>
        <result property="shfitDate" column="shfit_date"/>
        <result property="shfitStartTime" column="shfit_start_time"/>
        <result property="shfitState" column="shfit_state"/>
    </resultMap>


    <select id="findBusShfit" resultMap="busShfitMap">
        SELECT * from tb_bus_shfit where shfit_state='未发车' limit 1
    </select>
<!--插入司机工作量表-->
    <insert id="insertDriverWorkload" parameterType="map">
        INSERT INTO tb_driver_workload(bus_id,route_id,driver_id)
        select tb_bus.bus_id, tb_route.route_id, tb_driver.driver_id
        FROM tb_bus, tb_route, tb_driver
        WHERE tb_bus.bus_license = #{busName} and tb_route.route_name=#{routeName} and tb_driver.driver_name=#{driverName}
    </insert>
<!--插入司机考勤表-->
    <insert id="addGateCard" parameterType="map">
        INSERT INTO tb_gate_card(driver_id,office_hours,work_date)
select driver_id ,#{shfit_start_time},#{shfit_date} FROM tb_driver where driver_name=#{driverName}
    </insert>
<!--更新发车表状态-->
    <update id="updateBusShfitState" parameterType="int">
        update tb_bus_shfit SET shfit_state='已发车' where shfit_id=#{shfitId}
    </update>
</mapper>